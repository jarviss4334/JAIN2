<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat App</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <div class="rotating">FREE KONA</div>
  </header>

  <div id="main">
    <div id="chatArea">
      <div id="header">Global Chat</div>
      <div id="messages"></div>
      <div id="composer">
        <input type="text" id="msgInput" placeholder="Type a message..." />
        <button id="sendBtn">Send</button>
      </div>
    </div>
  </div>

  <div id="nameModal">
    <div id="nameBox">
      <h3>Enter your name</h3>
      <input type="text" id="nameInput" placeholder="Your name" />
      <button id="pickBtn">Join Chat</button>
    </div>
  </div>

  <div id="roomModal">
    <div id="roomBox">
      <h3>Create or Join Room</h3>
      <button id="createRoomBtn">Create Room</button>
      <div id="joinRoom">
        <input type="text" id="roomCodeInput" placeholder="Enter Room Code" />
        <button id="joinRoomBtn">Join Room</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');
    const messages = document.getElementById('messages');
    const nameModal = document.getElementById('nameModal');
    const nameInput = document.getElementById('nameInput');
    const pickBtn = document.getElementById('pickBtn');
    const roomModal = document.getElementById('roomModal');
    const createRoomBtn = document.getElementById('createRoomBtn');
    const joinRoomBtn = document.getElementById('joinRoomBtn');
    const roomCodeInput = document.getElementById('roomCodeInput');
    let currentRoom = 'global';

    function addMessage(msg) {
      const msgEl = document.createElement('div');
      msgEl.classList.add('msg', msg.system ? 'system' : msg.username === 'You' ? 'me' : 'them');
      msgEl.innerHTML = `<strong>${msg.username}</strong>: ${msg.text}`;
      messages.appendChild(msgEl);
      messages.scrollTop = messages.scrollHeight;
    }

    socket.on('chat:message', addMessage);

    socket.on('users:update', (users) => {
      // Update user list if needed
    });

    pickBtn.addEventListener('click', () => {
      const name = nameInput.value.trim();
      if (name) {
        socket.emit('user:join', name, (response) => {
          if (response.ok) {
            nameModal.style.display = 'none';
            roomModal.style.display = 'block';
          }
        });
      }
    });

    sendBtn.addEventListener('click', () => {
      const text = msgInput.value.trim();
      if (text) {
        socket.emit('chat:message', text, currentRoom !== 'global' ? currentRoom : null);
        msgInput.value = '';
      }
    });

    createRoomBtn.addEventListener('click', () => {
      socket.emit('room:create', (response) => {
        if (response.ok) {
          currentRoom = response.roomCode;
          roomModal.style.display = 'none';
          document.getElementById('header').textContent = `Room ${currentRoom}`;
          document.body.style.backgroundImage = 'url("https://files.catbox.moe/1juetm.jpg")';
        }
      });
    });

    joinRoomBtn.addEventListener('click', () => {
      const roomCode = roomCodeInput.value.trim();
      if (roomCode) {
        socket.emit('room:join', roomCode, (response) => {
          if (response.ok) {
            currentRoom = roomCode;
            roomModal.style.display = 'none';
            document.getElementById('header').textContent = `Room ${currentRoom}`;
            document.body.style.backgroundImage = 'url("https://files.catbox.moe/1juetm.jpg")';
          } else {
            alert(response.error);
          }
        });
      }
    });

    // Initial setup
    nameModal.style.display = 'block';
    roomModal.style.display = 'none';
  </script>
</body>
</html>
