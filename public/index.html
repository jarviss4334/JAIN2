<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FREE KONA Chat</title>
  <link rel="stylesheet" href="style.css" />
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <header>
    <h1>FREE KONA</h1>
  </header>

  <div style="display: flex; flex: 1; overflow: hidden;">
    <aside id="sidebar">
      <h3>Online Users</h3>
      <hr />
      <div id="users"></div>
    </aside>

    <main id="main">
      <div id="chatArea">
        <div id="header">Global Chat</div>
        <div id="messages"></div>
        <div id="composer">
          <input id="msgInput" type="text" placeholder="Type a message..." autocomplete="off" />
          <button id="sendBtn">Send</button>
        </div>
      </div>
    </main>
  </div>

  <!-- Name selection modal -->
  <div id="nameModal">
    <div id="nameBox">
      <h3>Enter your name</h3>
      <input id="nameInput" type="text" placeholder="Your name..." />
      <button id="pickBtn">Join</button>
    </div>
  </div>

  <script>
    const socket = io();
    const nameModal = document.getElementById('nameModal');
    const nameInput = document.getElementById('nameInput');
    const pickBtn = document.getElementById('pickBtn');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');
    const messagesDiv = document.getElementById('messages');
    const usersDiv = document.getElementById('users');

    let my = { name: null };

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    pickBtn.onclick = () => {
      const desiredName = nameInput.value.trim();
      if (!desiredName) return;
      socket.emit('user:join', desiredName, (res) => {
        if (res.ok) {
          my.name = res.assignedName;
          nameModal.style.display = 'none';
        }
      });
    };

    sendBtn.onclick = sendMessage;
    msgInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendMessage();
    });

    function sendMessage() {
      const text = msgInput.value.trim();
      if (!text) return;
      socket.emit('chat:message', text);
      msgInput.value = '';
    }

    function renderMessage(msg) {
      const d = document.createElement('div');
      d.className = 'msg ' + (msg.username === my.name ? 'me' : 'them') + ' wobble ripple';
      const t = new Date(msg.ts);

      if (msg.system) {
        d.innerHTML = `<div class="small" style="text-align:center;color:#fcb045;"><em>${escapeHtml(msg.text)}</em></div>`;
      } else {
        d.innerHTML = `
          <div style="font-size:12px; color:#bbb;">
            <strong>${escapeHtml(msg.username)}</strong>
            <span class="small">${t.toLocaleTimeString()}</span>
          </div>
          <div>${escapeHtml(msg.text)}</div>`;
      }

      messagesDiv.appendChild(d);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;

      d.addEventListener('animationend', () => {
        d.classList.remove('wobble', 'ripple');
      });
    }

    socket.on('chat:message', renderMessage);

    socket.on('users:update', (list) => {
      usersDiv.innerHTML = '';
      list.forEach((u) => {
        const div = document.createElement('div');
        div.className = 'user';
        div.textContent = u;
        usersDiv.appendChild(div);
      });
    });
  </script>
</body>
</html>
